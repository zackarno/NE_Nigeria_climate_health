---
title: "monthly_env_data_wards"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries & functions



```{r libraries}
library(tidyverse)
library(rgee)
library(sf)
invisible(purrr::map(list.files(here::here("R"),full.names = T),.f = source))
```


Now that we have a better understanding of data and limitations it makes sense to re-think how the data is extracted from GEE. Once it is extracted it should be cleanly compiled into several long format data.frames which can be stored as a list and saved as an `rds` file.

- OTP data 
  + All 3 states: Yobe, Maiduguri, Adamawa at LGA level (still some LGA cleaning required)
  + No ward level data
- AWD Data
  + Just Borno State at LGA & Ward level. Ward data is too dirty to be used for entire state.
  + Majority of data in Maiduguri & Jere. We have had those wards cleaned to acceptable level
  

## Aggregations Descriptuibs

**Spatial:**

- State (all 3)
- LGA (in all 3 States),
- LGA (Maiduguri & Jere dissolved)
- Wards (in Maiduuri & Jere LGAs only)

**Temporal:**

- CHIRPS rainfall
  + daily precipitation - mean value per admin
  + monthly precipitation (summed at pixel level) - mean value per admin
- MODIS TERRA (params: NDVI, Zscore NDVI, diff NDVI, VCI):
  + 16 day composites - mean value per admin
  + Monthly composite (max NDVI pixel level) - mean value per admin
- SMAP Soil Moisture (moisture params: ssm, susm, smp)
  + 3 day moisture parameters - mean value per admin
  + Monthly composite (mean or max val pixel level) - mean value per admin
- Surface Temp

  
  
  

## Data


```{r load_data}

ee_Initialize()

# 16 day ndvi composites
ndvi_dat_src <- "MODIS/006/MOD13Q1"
ndvi <- ee$ImageCollection(ndvi_dat_src)



# ee_get_date_ic(ndvi)

soil_moisture_src <- "NASA_USDA/HSL/SMAP10KM_soil_moisture"
soil_moisture <- ee$ImageCollection(soil_moisture_src)

chirps_src <- "UCSB-CHG/CHIRPS/DAILY"
chirps <- ee$ImageCollection(chirps_src)

# awd <- readxl::read_excel(here::here("data/Borno_EWARS_awd_under5_2017_2021.xlsx")) |> 
#   rename(ADM2_EN = `...1`)

muac <- read_rds(file = here::here("data/muac_201701_202111.rds"))
admins <- load_nga_admins()

ward <- admins$ward

# wards of interest
woi <- ward %>% 
  filter(ADM2_EN %in% c("Maiduguri","Jere"))

admins <-  load_nga_admins()







chirps_gte2016 <- chirps$filterDate("2016-01-01", "2021-12-31")
smap_gte2016 <- soil_moisture$
  filterDate("2016-01-01", "2022-01-19")$
  select("ssm","susm","smp")
ndvi_gte2016 <- ndvi$filterDate("2016-01-01", "2022-01-01")$select("NDVI","EVI")


smap_gte2016 |> ee_get_date_ic()
smap_gte2016$first()$bandNames()$getInfo()
```


# Most granular temporal

## Get 2016-2020 data 

### Define spatial levels

```{r}

spatial_levels <-  list()

# state level
spatial_levels$ne_states_all <-  admins$state |> 
  filter(ADM1_EN %in% c("Borno","Adamawa","Yobe"))

# lga level
spatial_levels$ne_lgas_all <- admins$lga |> 
  filter(ADM1_EN %in% c("Borno","Adamawa","Yobe"))

# lga level
spatial_levels$mj_lgas_dissolved <- admins$lga |> 
  filter(ADM2_EN %in% c("Maiduguri","Jere")) |> 
  summarise() |> 
  mutate(ADM2_EN="Maiduguri_Jere")

# maiduguri & Jere LGA wards
spatial_levels$mj_wards <- admins$ward |> 
  filter(ADM2_EN %in% c("Maiduguri","Jere"))



# see if this makes a difference - comps get timed out otherwise
spatial_levels <-  spatial_levels |> 
  map(~st_simplify(x = .x,dTolerance = 0.7))
# get proper end dates
# chirps |> ee_get_date_ic() |> pull(time_start) |> range()
# soil_moisture |> ee_get_date_ic() |> pull(time_start) |> range()
# ndvi |> ee_get_date_ic() |> pull(time_start) |> range()


names(spatial_levels)
spatial_levels <- spatial_levels |> 
  list_modify("mj_wards"=NULL) 
spatial_level_extract_cols <-  c("ADM1_EN","ADM2_EN","ADM2_EN")
length(spatial_level_extract_cols)
names(spatial_levels)
```


### Extract CHIRPS, MODIS, SMAP
```{r}

# chirps daily
system.time(
  chirps_gte2016_agg_mean <-spatial_levels |> 
  map2(.y = spatial_level_extract_cols,.f = ~ee_extract_long(ic = chirps_gte2016,
                                                             sf = .x,
                                                             sf_col = .y,
                                                             scale =5500,
                                                             reducer = "mean")
  )
)

# NDVI 16 day
system.time(
  ndvi_gte2016_agg_mean <-spatial_levels |> 
  map2(.y = spatial_level_extract_cols,.f = ~ee_extract_long(ic = ndvi_gte2016,
                                                             sf = .x,
                                                             sf_col = .y,
                                                             scale =5500,
                                                             reducer = "mean")
  )
)

# SMAP 16 day
system.time(
  smap_gte2016_agg_mean <-spatial_levels |> 
  map2(.y = spatial_level_extract_cols,.f = ~ee_extract_long(ic = smap_gte2016,
                                                             sf = .x,
                                                             sf_col = .y,
                                                             scale =5500,
                                                             reducer = "mean")
  )
)




modis_chirps_smap_time_raw <- list()
modis_chirps_smap_time_raw$modis <- names(ndvi_gte2016_agg_mean) |> 
  map_dfr(~ndvi_gte2016_agg_mean[[.x]] |> 
        mutate(
          level = .x,
          time_desc = "16-day MODIS" 
        ) |> 
         rename_with(.fn = ~"ADM_NAME",.cols = matches("ADM"))
      ) 

modis_chirps_smap_time_raw$chirps <- names(chirps_gte2016_agg_mean) |> 
  map_dfr(~chirps_gte2016_agg_mean[[.x]] |> 
        mutate(
          level = .x,
          time_desc = "1-day CHIRPS" 
        ) |> 
         rename_with(.fn = ~"ADM_NAME",.cols = matches("ADM")))



modis_chirps_smap_time_raw$smap <- names(smap_gte2016_agg_mean) |> 
  map_dfr(~smap_gte2016_agg_mean[[.x]] |> 
        mutate(
          level = .x,
          time_desc = "3-day SMAP" 
        ) |> 
        rename_with(.fn = ~"ADM_NAME",.cols = matches("ADM"))
        ) #|> 
  

modis_chirps_smap_time_raw_df <- bind_rows(modis_chirps_smap_time_raw)
modis_chirps_smap_time_raw_df |> 
  pivot_wider(id_cols = c(date,ADM_NAME),names_from= parameter, values_from=value) |> 
  arrange(date) |> 
  print(n=600)

```


### Add MODIS NDVI historical comparisons
- need to work in VCI
<!-- https://journals.ametsoc.org/view/journals/clim/23/3/2009jcli2900.1.xml -->
  + VCI = (NDVI-NDVImin)/(NDVImax-NDVImin)
  +VHI

```{r}
ndvi <- ndvi$
  select("NDVI","EVI")$
  map(
    ee_utils_pyfunc(
      function(x){x$
          multiply(0.0001)$
          copyProperties(x,x$propertyNames())
          }
    )
  )



ndvi_2000_2010<- ndvi$filterDate("2000-01-01", "2010-12-31")$
  select("NDVI","EVI")
ndvi_gte2016 <- ndvi$filterDate("2016-01-01", "2022-01-01")$select("NDVI","EVI")


# I need to figure out trick to combine reducers so the 4 stats below can be calculated together
 ndvi_10yr_mean<- yr_mo_composite_stat_ic2(dat =ndvi_2000_2010,
                                      month_range = c(1,12),
                                      year_range = c(2000,2010),
                                      stat = "mean",
                                      monthly_stat_per = "range") |> 
   ic_add_month_property()
 
 
 ndvi_10yr_sd<- yr_mo_composite_stat_ic2(dat =ndvi_2000_2010,
                                      month_range = c(1,12),
                                      year_range = c(2000,2010),
                                      stat = c("sd"),
                                      monthly_stat_per = "range") |> 
   ic_add_month_property()
 ndvi_10yr_min<- yr_mo_composite_stat_ic2(dat =ndvi_2000_2010,
                                      month_range = c(1,12),
                                      year_range = c(2000,2010),
                                      stat = c("min"),
                                      monthly_stat_per = "range") |> 
   ic_add_month_property()
 
 ndvi_10yr_max<- yr_mo_composite_stat_ic2(dat =ndvi_2000_2010,
                                      month_range = c(1,12),
                                      year_range = c(2000,2010),
                                      stat = c("max"),
                                      monthly_stat_per = "range") |> 
   ic_add_month_property()

 
 # new func
 ndvi_10yr_stats <- ndvi_10yr_mean |> 
   ic_join_bands(y = ndvi_10yr_sd,by = "moy") |>  
   ic_join_bands(y=ndvi_10yr_max,by = "moy") |> 
   ic_join_bands(y=ndvi_10yr_min,by = "moy") 



ndvi_gte2016_w_historical_bands<- ic_join_bands(x = ndvi_gte2016 |> ic_add_month_property(),
                                                    y = ndvi_10yr_stats |> ic_add_month_property(),
                                                    by = "moy")


# this is still a bit ugly - opened issue wrap simplifier
ndvi_zscore<- ndvi_gte2016_w_historical_bands$map(
  function(img){
    zscore<- img$expression(
      "float((NDVI-NDVI_mean)/(NDVI_stdDev))",
      opt_map= list(NDVI= img$select("NDVI"),
                    NDVI_mean= img$select("NDVI_mean"),
                    NDVI_stdDev= img$select("NDVI_stdDev")
      )
    )$rename("NDVI_z_score")
    img$select("NDVI","EVI")$addBands(zscore)
  }
  
) 

# ndvi_zscore$first()$projection()$nominalScale()$getInfo()
# ee_extract_long |> debugonce()
# ck <- ee_extract_long(ic = ndvi_zscore,sf = spatial_levels$mj_lgas_dissolved,sf_col = "ADM2_EN",scale = 250,reducer = "mean")


  # NDVI 16 day
system.time(
  ndvi_gte2016_agg_mean <-spatial_levels |> 
  map2(.y = spatial_level_extract_cols,.f = ~ee_extract_long(ic = ndvi_zscore,
                                                             sf = .x,
                                                             sf_col = .y,
                                                             scale =250,
                                                             reducer = "mean")
  )
)


modis_chirps_smap_awd_otp_time_raw_df |> count(time_desc)


ndvi_gte2016_agg_mean_df <- names(ndvi_gte2016_agg_mean) |> 
  map_dfr(~ndvi_gte2016_agg_mean[[.x]] |> 
        mutate(
          level = .x,
          time_desc = "16-day MODIS" 
        ) |> 
         rename_with(.fn = ~"ADM_NAME",.cols = matches("ADM"))
      ) 


modis_chirps_smap_awd_otp_mz_time_raw_df <- bind_rows(modis_chirps_smap_awd_otp_time_raw_df |> 
  filter(time_desc!="16-day MODIS") ,
  ndvi_gte2016_agg_mean_df
)
  # 
# modis_chirps_smap_awd_otp_mz_time_raw_df |> 
  # write_rds(here::here("data/modis_chirps_smap_awd_otp_orig_ts.rds"))


```



#  OTP & AWD data in long format to bind 

also should calculate prevalence by dividing by pop #
```{r}

pop <-  read_csv(here::here("data/pop_lga_msna2019_sf.csv"))
awd <- load_awd(lgas = NULL)
awd_w_pop <- awd |> 
  left_join(
    
    admins$lga |> 
      st_drop_geometry() |> 
      select(ADM2_EN,ADM2_PCODE),
    by="ADM2_EN"
  ) |> 
  left_join(pop, by="ADM2_PCODE") 
library(lubridate)
modis_chirps_smap_time_raw_df |> count(level)  
awd_w_pop_prev_long <- awd_w_pop |> 
  mutate(
    date= ymd(date),
    awd_cases=as.numeric(cases),
    awd_prev_per_1000=awd_cases/pop*1000,
    # cases_calc= (prev*pop)/1000
  ) |> 
  rename(ADM_NAME="ADM2_EN") |> 
  select(ADM_NAME, date, awd_cases, awd_prev_per_1000) |> 
  pivot_longer(awd_cases:awd_prev_per_1000,names_to="parameter") |> 
  mutate(
    level="ne_lgas_borno",
    time_desc= "1-week AWD"
  )


modis_chirps_smap_awd_time_raw_df <- bind_rows(modis_chirps_smap_time_raw_df,awd_w_pop_prev_long)


otp <-  read_rds(here::here("data/20220121_MUAC_w_maidu_jere_wards_harmonized.rds"))
# a little extra cleaning required
otp_cleaned <- otp |> 
  select(date=date_dt, State, LGA=LGA_crct,Ward=ward_crct,new_otp_admissions,muac_total_screened) |> 
  # a little additional cleaning. 
  # assume if there are records for muac screenings then facility was open and NA for OTP admissions = 0
  mutate(new_otp_admissions=if_else(!is.na(muac_total_screened),replace_na(new_otp_admissions,0),new_otp_admissions)) |> 
  filter(!is.na(date)) |> 
  filter(date>"2010-01-01") # weird outlier removal

# show relationship between wards reporting and total cases
otp_cleaned|> 
  group_by(LGA,date,.drop=F ) |> 
  summarise(
    otp_cases=sum(new_otp_admissions,na.rm=T),
    wards_reporting = sum(!is.na(new_otp_admissions)),
    .groups = "drop"
  ) |> 
  ggplot(aes(x= wards_reporting,y=otp_cases))+
  geom_point()

# dang its a bit more complicated because some LGAs just are bigger...hmmm why dont i just
# add number of wards reporting and overall pop and we can account for these


otp_by_lga <- otp_cleaned|> 
  group_by(LGA,date,.drop=F ) |> 
  summarise(
    otp_cases=sum(new_otp_admissions,na.rm=T),
    wards_reporting = sum(!is.na(new_otp_admissions)),
    .groups = "drop"
  ) |> 
  left_join(
    admins$lga |> 
      st_drop_geometry() |> 
      select(ADM2_EN,ADM2_PCODE),
    by=c("LGA"="ADM2_EN")
  ) |> filter(!is.na(ADM2_PCODE)) |> # remove 3 typos -- not clear what they are, but only had 1 record each
  left_join(pop, by="ADM2_PCODE") |> 
  mutate(
    otp_cases_per_1000=(otp_cases/pop)*1000
  ) |> 
  rename(ADM_NAME="LGA") |> 
  select(ADM_NAME,date, otp_cases,otp_cases_per_1000,wards_reporting) |> 
  pivot_longer(otp_cases:wards_reporting,names_to = "parameter") |> 
  mutate(
    level= "ne_lgas_all",
    time_desc= "1-month OTP"
    
         )




modis_chirps_smap_awd_otp_time_raw_df<- bind_rows(modis_chirps_smap_awd_time_raw_df,otp_by_lga)

# modis_chirps_smap_awd_otp_time_raw_df |>
#   write_rds(here::here("data/modis_chirps_smap_awd_otp_orig_ts.rds"))
```


# Clean up
- we have all the data in long format now together
- we want to produce the data spatio temporal aggregations of interest now....
- we might want to engineer some dates for monthly data

```{r}
library(janitor)
library(lubridate)
library(glue)
mdf <- read_rds(here::here("data/modis_chirps_smap_awd_otp_orig_ts.rds"))

# for OTP data we have no choice but to look at monthly data
# for AWD we can potentially do weekly, but will be hard to get NDVI at weekly

lga_level_dat <- mdf |> 
  filter(year(date)>=2017) |> 
  mutate(
    mo_date= glue("{year(date)}-{month(date)}-01"),
    level2= if_else(level %in% c("ne_lgas_all","ne_lgas_borno"),"lga",level)
  ) |> 
  filter(level2=="lga")


# calculate rolling sums
precip_rolling_sums<- lga_level_dat |> 
  filter(parameter=="precipitation") |> 
  group_by(ADM_NAME) |>
  mutate(
    rollsum_1day  =zoo::rollsum(x = value, k=1, align = "right", fill = NA),
    rollsum_3day  =zoo::rollsum(x = value, k=3, align = "right", fill = NA),
    rollsum_5day  =zoo::rollsum(x = value, k=5, align = "right", fill = NA),
    rollsum_10day  =zoo::rollsum(x = value, k=10, align = "right", fill = NA),
  ) |> ungroup()


# summarise rolling sums with max vals (wide)
precip_rolling_stats <- precip_rolling_sums |> 
  group_by(ADM_NAME,mo_date) |>
  summarise(
    precip_max_1day= max(rollsum_1day,na.rm=T),
    precip_max_3day= max(rollsum_3day,na.rm=T),
    precip_max_5day= max(rollsum_5day,na.rm=T),
    precip_max_10day= max(rollsum_10day,na.rm=T),.groups = "drop"
  ) 
  

# summarise lga data to month
monthly_lga_level <- lga_level_dat |> 
  group_by(parameter,mo_date,ADM_NAME) |>
  arrange(ADM_NAME) |>
  summarise(
    value_mean=mean(value,na.rm=T),
    value_sum= sum(value,na.rm=T),
    .groups="drop"
  ) |> 
  mutate(value= if_else(parameter%in%c("precipitation","awd_cases","otp_cases"), value_sum,value_mean))


# pivot wider  and add on precip stats
monthly_lga_wide <- monthly_lga_level |> 
  select(-value_mean,
         -value_sum) |> 
  pivot_wider(
    id_cols = c("ADM_NAME","mo_date"),
    names_from=parameter,
    values_from=value
    ) |> 
  left_join(precip_rolling_stats)


# i think this is a pretty reasonable dat set to use for modeling
otp_monthly_full <- monthly_lga_wide |> 
  filter(!is.na(otp_cases))
```


```{r}
admins <- load_nga_admins()
otp_monthly_full <- otp_monthly_full |>
  group_by(
    # yr=year(mo_date)
    ADM_NAME
    ) |> 
  mutate(
    otp_z=(otp_cases-mean(otp_cases,na.rm=T))/sd(otp_cases),
    precip_z=(precipitation-mean(precipitation,na.rm=T))/sd(precipitation)
    ) |> 
  ungroup()



mtcars <- as_tibble(mtcars)  # to play nicely with list-cols

nest_mtcars <- mtcars %>%
  nest(data = c(-am)) 

nest_mtcars %>% 
  mutate(
    fit = map(data, ~ lm(wt ~ mpg + qsec + gear, data = .x)),  # S3 list-col
    # tidied = map(fit, broom::tidy)
  ) %>% 
  unnest(tidied) %>% 
  select(-data, -fit)
  
otp_monthly_full$precipitation
nest_otp <- otp_monthly_full %>%
  filter(!is.na(otp_cases_per_1000)) |> 
  filter(!is.na(precipitation)) |> 
  nest(data = c(-ADM_NAME)) 

# need to add wards reporting.
bla <- otp_monthly_full |> 
  filter(ADM_NAME=="Nganzai")
boom<- lm(otp_cases_per_1000~precipitation+precip_max_3day, data= bla) |> broom::glance()
summary(boom)
# 59/12
# otp_monthly_full$mo_date |> unique()
nest_otp |> 
  mutate(
    # fit = map(data, ~ lm(otp_cases_per_1000~precipitation, data = .x)),
    # fit = map(data, ~ lm(otp_cases_per_1000~+precip_max_1day, data = .x)),
    # fit = map(data, ~ lm(otp_cases_per_1000~susm, data = .x)),
    fit = map(data, ~ lm(otp_cases_per_1000~susm+ssm+smp, data = .x)),
    # fit = map(data, ~ lm(otp_cases_per_1000~precipitation+susm, data = .x)),
    # THIS IS INTERSTING
  
    # fit = map(data, ~ lm(otp_cases_per_1000~NDVI_z_score, data = .x)),
    # CHECKING OUT ROLLLING MAX WITH NDVI Z -- NOT HUGE AFFECT
    # fit = map(data, ~ lm(otp_cases_per_1000~NDVI_z_score+precip_max_1day, data = .x)),
    # fit = map(data, ~ lm(otp_cases_per_1000~NDVI, data = .x)),
    tidied = map(fit,broom::tidy),
    glanced= map(fit, broom::glance)
  ) |> 
  # unnest(tidied) %>% 
  unnest(glanced) %>% 
  select(-data, -fit) |> 
  # filter(term=="precipitation") |> 
  # filter(ADM_NAME=="Maiduguri")
  filter(p.value<0.05) |> 
  arrange(desc(adj.r.squared))
  print(n=23)

# some interesting results particularly magumeri
# lets check it out in more detail
  
otp_monthly_full |> 
  filter(ADM_NAME=="Magumeri") |> 
  ggplot(aes(x=NDVI_z_score,y=otp_cases_per_1000))+
  geom_point()+
  scale_y_log10()+
  labs(x= "NDVI Z score",y= "OTP cases per 1000",title = "Magumeri LGA")+
  geom_smooth(method="lm")+
  theme_bw()

otp_monthly_full |> 
  filter(ADM_NAME=="Gwoza") |> 
  ggplot(aes(x=NDVI_z_score,y=otp_cases_per_1000))+
  geom_point()+
  scale_y_log10()+
  labs(x= "NDVI Z score",y= "OTP cases per 1000",title = "Gwoza LGA")+
  geom_smooth(method="lm")+
  theme_bw()

otp_monthly_full |> 
  filter(ADM_NAME=="Konduga") |> 
  ggplot(aes(x=NDVI_z_score,y=otp_cases_per_1000))+
  geom_point()+
  scale_y_log10()+
  labs(x= "NDVI Z score",y= "OTP cases per 1000",title = "Magumeri LGA")+
  geom_smooth(method="lm")+
  theme_bw()

otp_monthly_full |> 
  filter(ADM_NAME=="Magumeri") |> 
  ggplot(aes(x=precipitation))+
  geom_histogram()
  geom_point()+
  scale_y_log10()
otp_monthly_full |> 
  filter(ADM_NAME=="Magumeri") |> 
  ggplot(aes(x=precipitation))+
  geom_histogram()
  geom_point()+
  scale_y_log10()

  
  
  # should i make a model mapper function?
  # for each model pull out p, r.adj of significant lgas
  # create facet plot
  # create leaflet map?... how to suppl
  
nga_model_vis <- function(df=nest_otp,lm_formula){
  res <-  list()
  formulaized_lm <- formula(lm_formula)
  
  sig_model_stats_tbl <- df |> 
     mutate(
       fit = map(data, ~ lm(formulaized_lm, data = .x)),
       tidied = map(fit,broom::tidy),# not actually using now, but might later
       glanced= map(fit, broom::glance) 
     ) |> 
    unnest(glanced) %>% 
    select(-data, -fit) |> 
    filter(p.value<0.05) |> 
    arrange(desc(adj.r.squared))
  
  sig_admin_names <- sig_model_stats_tbl$ADM_NAME
      
   
   ind= all.vars(formulaized_lm)[1]
   deps= all.vars(formulaized_lm)[-1]
   
   sig_df_unnested <- df |> 
     filter(ADM_NAME %in% sig_admin_names) |>
     unnest(data)
     
   plot_list<- deps |> 
       map(~sig_df_unnested |> 
       ggplot(aes(x=!!sym(ind), y= !!sym(.x) ))+
       geom_point()+
       geom_smooth(method="lm",formula="y~x")
       ) |> 
     set_names(paste0("plot_",deps))
   
  
   
     
     
   }
   
  }
nga_model_vis(df = nest_otp,lm_formula = "otp_cases_per_1000~susm+ssm+smp")  
  
  
  
  
  
  
  
  
  
  
  

otp_monthly_full |> 
  nest(
    ADM_NAME
  ) |> 
  mutate(
    fit= map(data, ~lm(otp_cases_per_1000~precipitation, data=.x))
    
    ) 

lm(otp_cases_per_1000~precipitation+NDVI, otp_monthly_full ) |> summary()



```





weekly_lga <- mdf |> 
  filter(year(date)>=2017) |> 
  mutate(
    level2= if_else(level %in% c("ne_lgas_all","ne_lgas_borno"),"lga",level)
  ) |> 
  filter(level2=="lga") |> 
  # lets see how weekly looks - our only problem should be modis
  group_by(parameter,yr=year(date),wk=week(date),ADM_NAME) |>
  # filter(yr==2017, wk==1, parameter=="precipitation") |>
  arrange(ADM_NAME) |>
  # summarise(value=mean(value)) |> print(n=65)
  summarise(
    value_mean=mean(value,na.rm=T),
    value_sum= sum(value,na.rm=T),
    # value_sum = if_else(parameter=="precipitation", sum(value,na.rm=T),mean(value,na.rm=T)),
    .groups="drop"
  ) |> 
  mutate(value= if_else(parameter%in%c("precipitation","awd_cases","otp_cases"), value_sum,value_mean))
weekly_lga$ADM_NAME |> unique() |> length()
admins$lga |> 
  filter(ADM1_EN=="Borno") |> 
  pull(ADM2_EN) |> unique() 

weekly_lga |> 
  mutate(wk_date = ymd(str_c(yr,"-01-01"))+weeks(wk)) |> 
  select(-value_mean,
         -value_sum) |> 
  pivot_wider(
    id_cols = c("ADM_NAME","wk_date"),
    names_from=parameter,
    values_from=value
    ) |>
  filter(!is.na(awd_cases)) |>
  ggplot(aes(x=wk_date,y = awd_cases, color=ADM_NAME))+
  geom_line()+
  facet_wrap(~ADM_NAME,scales = "free_y")
  count(ADM_NAME)|> 
  print(n=23)
  
  print(n=100)
  filter(!is.na(otp_cases)) # |>
  # janitor::
# weekly_lga |> 


maidu_params_split <- lga_level_dat |> 
  filter(ADM_NAME%in%c("Maiduguri")) |> 
  group_split(parameter)

maidu_awd <- maidu_params_split[[1]] |> 
  rename(awd_cases="value") 

maidu_awd_xts<- xts::xts(maidu_awd$awd_cases,order.by=maidu_awd$date)

maidu_precip <- maidu_params_split[[8]] |> 
  rename(precip="value") 

maidu_precip_xts<- xts::xts(maidu_precip$precip,order.by=maidu_precip$date)
maidu_precip_xts |> head()
maidu_awd_xts |> head()

merge(x = maidu_awd_xts,maidu_precip_xts) |> head()



mdf |> 
  filter(year(date)>=2017) |> 
  mutate(
    level2= if_else(level %in% c("ne_lgas_all","ne_lgas_borno"),"lga",level)
  ) |> 
  filter(level2=="lga") |> 
  # lets see how weekly looks - our only problem should be modis
  group_by(parameter,yr=year(date),wk=week(date),ADM_NAME) |>
  # filter(yr==2017, wk==1, parameter=="precipitation") |>
  arrange(ADM_NAME) |>
  # summarise(value=mean(value)) |> print(n=65)
  summarise(
    value_mean=mean(value,na.rm=T),
    value_sum= sum(value,na.rm=T),
    # value_sum = if_else(parameter=="precipitation", sum(value,na.rm=T),mean(value,na.rm=T)),
    .groups="drop"
  ) |> 
  mutate(value= if_else(parameter%in%c("precipitation","awd_cases","otp_cases"), value_sum,value_mean)) |> 
  select(-value_mean, - value_sum) |> 
  pivot_wider(id_cols = c("ADM_NAME",
                          # "level2",
                          "yr",
                          "wk"),names_from=parameter,
              values_from=value) |> 
  filter(!is.na(otp_cases)) |> 
  print(n=100)



```



```{r scraptest}
##### Creating the Shapefile 
st_geometry(spatial_levels$mj_wards) %>% print(n=nrow(.))
st_is_valid(spatial_levels$mj_wards)

tk2 <- spatial_levels$mj_wards |> 
  st_buffer(dist = 0)

library(sf)
library(cptcity) 
# debugonce(sf_as_ee)

mj_wards_ee <- spatial_levels$mj_wards |> 
  # select(ADM3_PCODE) |> 
  # slice(1) |> 
  # st_geometry() |>
  # st_as_sf() |> 
  # st_simplify(dTolerance = 0.7) |>
  sf_as_ee()
st_geometry

chirps_1day_ex<- chirps$filterDate("2019-07-10","2019-07-11")$max()
chirpsVis <- list(
  min = 0, 
  max = 50,
  palette = cpt("grass_bcyr")
)
Map$centerObject(mj_wards_ee)
Map$addLayer(
  eeObject = chirps_1day_ex,
  visParams = chirpsVis,
  name = 'Precipitation'
)#+Map$addLayer(mj_wards_ee)

library(leaflet)
leaflet() |> 
  # addTiles() |> 
  addProviderTiles("Esri.WorldImagery") |> 
  addPolygons(data=spatial_levels$ne_lgas_all) |>  
  addPolygons(data=spatial_levels$mj_wards |> st_simplify(dTolerance = 200),color = "red")
spatial_levels$mj_wards |> st_simplify(dTolerance = 200) |> object.size()
spatial_levels$mj_wards|> object.size()


```

```{r precipscrap}

monthly_precip <- yr_mo_composite_stat_ic(dat = chirps,
                                          month_range = c(1,12),
                                          year_range = c(1981,2021),
                                          stat = "sum")



monthly_precip_renamed <- monthly_precip$ 
  # CHIRPS release is delayed by a month or 2 so you need to pre-filter
  # or face difficulty later
  filterDate("1981-01-01","2021-11-30") |> 
  ee$ImageCollection$map(
    function(x) {
      date <- ee$Date(x$get("system:time_start"))$format('YYYY_MM_dd')
      name <- ee$String$cat("pr_", date)
      x$select("precipitation")$rename(name)
    })


system.time(
monthly_precip_ward <- ee_extract(x = monthly_precip_renamed,y=woi["ADM3_PCODE"],scale=5500,fun= ee$Reducer$mean(),sf=T)
)

monthly_precip_ward_long <- monthly_precip_ward |> 
       st_drop_geometry() |> 
  pivot_longer(-1) |> 
      mutate(
        parameter="precip",
        date= str_remove(string = name, pattern = ".*pr_") |> 
          str_replace_all("_","-") |> lubridate::ymd()

  ) 
  


```

## Soil Moisure
```{r soilmoisturescrap, eval=F}
soil_moisture %>% ee_get_date_ic() %>% pull(time_start) %>% range()
# soil_moisture
soil_moisture$first()$bandNames()$getInfo()
soil_moisture$select("ssm")$first() %>% ee_print()


monthly_soil_moisture <- yr_mo_composite_stat_ic(dat = soil_moisture$
                                         select("ssm","susm","smp"),

                                          month_range = c(1,12),
                                          year_range = c(2015,2021),
                                          stat = "mean")







monthly_soil_moisture <- monthly_soil_moisture$
  filterDate("2015-04-02","2022-01-10") 

soil_moisture_3_day <- soil_moisture$
  filterDate("2015-04-02","2022-01-10") 

monthly_soil_moisture_renamed <- monthly_soil_moisture |> 

  ee$ImageCollection$map(
    function(x) {
      date <- ee$Date(x$get("system:time_start"))$format('YYYY_MM_dd')
      # band_names <- x$bandNames()$getInfo()
      # band_names_date <- 
      ssm_date <- ee$String$cat("ssm_", date)
      susm_date <- ee$String$cat("susm_", date)
      smp_date <- ee$String$cat("smp_", date)
      x$rename(ssm_date,susm_date,smp_date)
      
    })


soil_moisture_3_day_renamed <- soil_moisture_3_day$
  select("ssm","susm","smp") %>% 

  ee$ImageCollection$map(
    function(x) {
      date <- ee$Date(x$get("system:time_start"))$format('YYYY_MM_dd')
      # band_names <- x$bandNames()$getInfo()
      # band_names_date <- 
      ssm_date <- ee$String$cat("ssm_", date)
      susm_date <- ee$String$cat("susm_", date)
      smp_date <- ee$String$cat("smp_", date)
      x$rename(ssm_date,susm_date,smp_date)
      
    })



# should look up if this resolution (12.7 km) should be used rather than the 10 km provided by GEE
soil_moisture$first()$projection()$nominalScale()$getInfo()


woi_diss <-  woi %>% 
  summarise() %>% 
  st_simplify(dTolerance =  0.7)

system.time( #24 s
soil_moisture_3_day_mj <- ee_extract(x = soil_moisture_3_day_renamed,
                                         y=woi_diss,
                                         scale=10000,
                                         fun= ee$Reducer$mean(),
                                         sf=T)
)


system.time( #24 s
monthly_soil_moisture_ward <- ee_extract(x = monthly_soil_moisture_renamed,y=woi["ADM3_PCODE"],scale=10000,fun= ee$Reducer$mean(),sf=T)
)

monthly_soil_moisture_ward_long <- monthly_soil_moisture_ward |> 
       st_drop_geometry() |> 
      pivot_longer(-1) |> 
      mutate(
        parameter= str_extract(string = name,pattern = "smp|ssm|susm"),
        date= str_remove(string = name, pattern = ".*sm_|.*mp_") |> 
          str_replace_all("_","-") |> lubridate::ymd()
  )
  
soil_moisture_3_day_mj_long <- soil_moisture_3_day_mj |> 
       st_drop_geometry() |> 
      pivot_longer(-1) |> 
      mutate(
        parameter= str_extract(string = name,pattern = "smp|ssm|susm"),
        date= str_remove(string = name, pattern = ".*sm_|.*mp_") |> 
          str_replace_all("_","-") |> lubridate::ymd()
  )

# soil_moisture_3_day_mj_long %>% 
#     select(date,parameter,value) %>% 
#   write_rds("SMAP_soil_moisture_3day_maidu_jere.rds")


```




```{r somescrap}


year_sequence <- ee$List$sequence(2016,2021)

ndvi_gte2016$first()$bandNames()$getInfo()
summary_stats_ic$first()$bandNames()$getInfo()

wtfd <- year_sequence$map(
  ee_utils_pyfunc(
    function(y){
      month_sequence$map(
        ee_utils_pyfunc(
          function(m){
            
            # recent_yrmo<- ee$Image(ndvi_gte2016$
            #    filter(ee$Filter$calendarRange(y, y, 'year'))$
            #    filter(ee$Filter$calendarRange(m, m, 'month'))$
            #       first()
            # )
            recent_yrmo<- ee$ImageCollection(ndvi_gte2016$
                                               filter(ee$Filter$calendarRange(y, y, 'year'))$
                                               filter(ee$Filter$calendarRange(m, m, 'month'))
            )
            
            
            
            hist_yrmo <-  ee$Image(summary_stats_ic$
                                     filter(ee$Filter$calendarRange(2000, 2000, 'year'))$
                                     filter(ee$Filter$calendarRange(m, m, 'month'))$
                                     first()
            )
            ee$Image(recent_yrmo|> 
              ee$ImageCollection$
              map(
                function(img){
                  current_hist_combined <- img$addBands(hist_yrmo_ck)
                  current_hist_combined$expression(
                    expression="float((NDVI-NDVI_mean)/NDVI_stdDev)",
                    opt_map= list(NDVI= current_hist_combined$select("NDVI"),
                                  NDVI_mean= current_hist_combined$select("NDVI_mean"),
                                  NDVI_stdDev= current_hist_combined$select("NDVI_stdDev")
                    ))$rename("NDVI_Zscore")
                  
                  
                  
                }
              )
            )
            
          }
        )
      )
    }
  )
)



# WATCH this 
 recent_yrmo_ck<- ee$ImageCollection(ndvi_gte2016$
              filter(ee$Filter$calendarRange(2016, 2016, 'year'))$
              filter(ee$Filter$calendarRange(1, 1, 'month'))
           )
                 
           
            
 hist_yrmo_ck <-  ee$Image(summary_stats_ic$
                          filter(ee$Filter$calendarRange(2000, 2000, 'year'))$
                          filter(ee$Filter$calendarRange(1, 1, 'month'))$
                          first()
            )
recent_yrmo_ck$size()$getInfo()
recent_yrmo_ck |> ee_get_date_ic()

ee$List(recent_yrmo_ck |> 
  ee$ImageCollection$
  map(
    function(img){
      current_hist_combined <- img$addBands(hist_yrmo_ck)
        current_hist_combined$expression(
        expression="float((NDVI-NDVI_mean)/NDVI_stdDev)",
        opt_map= list(
        NDVI= current_hist_combined$select("NDVI"),
        NDVI_mean= current_hist_combined$select("NDVI_mean"),
        NDVI_stdDev= current_hist_combined$select("NDVI_stdDev")
        )
  )$rename("NDVI_Zscore")
    }
  )
)
ee$List
ee$ImageCollection$toList

# |> eCe_print()
              
wtfd_list<- wtfd$toList(wtfd$size())


# wtfd_list_indx <- wtfd_list$get(1)
wtfd_list_indx <- wtfd$get(1)
ee$Image(wtfd_list_indx) %>% ee_print()
suckit <- wtfd$
  map(
    ee_utils_pyfunc(
      function(x){
        x$
          map(
            ee$to
          )
      }
    )
  )
ee$ImageCollection$combine( )
ee$ImageCollection$fromImages(wtfd$flatten())$first() 
ee$ImageCollection$combine(wtfd$flatten)  
  
  wtfd$getInfo()
wtfd |> ee_print()  
ee$fromImages
wtf_ic$first()$getInfo()
wtfd$size()$getInfo()
wtfd$length()$getInfo()
wtfd$flatten()$flatten()$size()$getInfo()

ee$ImageCollection$merge(wtfd)
wtf_ic <- ee$ImageCollection$fromImages(ee$List(wtfd))
wtf_ic <- ee$ImageCollection$fromImages(wtfd$flatten()) 
wtf_ic <- ee$ImageCollection$fromImages(suckit) 

wtf_ic <- ee$ImageCollection$fromImages(wtfd) 
ee$Image(wtf_ic$first()) |> ee_print()

wtf_ic |> ee_print()
 
 
 
spent<- 40*7.40
worth <- 3.83*40 
(spent-worth)+worth

comp |> ee_print()
ndvi_gte2016 |> ee_print() # 138
evi <- image$expression( expression = "2.5 * (float(nir - red) / (nir + 6 * red - 7.5 * blue + 1))",
                         opt_map = list( nir = image$select("B8"),
                                         red = image$select("B4"),
                                         blue = image$select("B2")))$rename('EVI')

month_sequence <- ee$List$sequence(1,12)
year_sequence <- ee$List$sequence(2016,2021)

ndvi_rescaled_monthly_historical_mean <- month_sequence$map(
   ee_utils_pyfunc(
     function(m) {
       ndvi_mean <- ndvi_rescaled$filter(ee$Filter$calendarRange(2000, 2010, 'year'))$
         filter(ee$Filter$calendarRange(m, m, 'month'))$
         mean()$
         rename("NDVI_mean")$
         set("system:time_start", ee$Date$millis(ee$Date$fromYMD(2000,m,1)) )
       
       ndvi_std <- ndvi_rescaled$filter(ee$Filter$calendarRange(2000, 2010, 'year'))$
         filter(ee$Filter$calendarRange(m, m, 'month'))$
         reduce(ee$Reducer$stdDev())$
         rename("NDVI_std")$
         set("system:time_start", ee$Date$millis(ee$Date$fromYMD(2000,m,1)) )
       
       
       ndvi_mean$addBands(ndvi_std)
     }

)
)

historical_range_to_monthly_composite_ic<- function(ic,year_range,month_seq){
  
  
  
  
}


composi

# try simplifying above
ndvi_rescaled_monthly_historical_mean <- month_sequence$map(
   ee_utils_pyfunc(
     function(m) {
       ndvi_tfilt <- ndvi_rescaled$filter(ee$Filter$calendarRange(2000, 2010, 'year'))$
         filter(ee$Filter$calendarRange(m, m, 'month'))
       
       
       ndvi_mean <- ndvi_tfilt$
         mean()$
         rename("NDVI_mean")$
         set("system:time_start", ee$Date$millis(ee$Date$fromYMD(2000,m,1)) )
       
       ndvi_min <- ndvi_tfilt$
         min()$
         rename("NDVI_min")$
         set("system:time_start", ee$Date$millis(ee$Date$fromYMD(2000,m,1)) )
       
       ndvi_max <- ndvi_tfilt$
         max()$
         rename("NDVI_max")$
         set("system:time_start", ee$Date$millis(ee$Date$fromYMD(2000,m,1)) )
       
       ndvi_std <-ndvi_tfilt$
         reduce(ee$Reducer$stdDev())$
         rename("NDVI_std")$
         set("system:time_start", ee$Date$millis(ee$Date$fromYMD(2000,m,1)) )
       
       
       
       ndvi_mean$addBands(ndvi_min)$addBands(ndvi_max)$addBands(ndvi_std)
     }

)
)

ndvi_rescaled_monthly_historical_mean <- ee$ImageCollection$fromImages(ndvi_rescaled_monthly_historical_mean$flatten()) 

ndvi_rescaled_monthly_historical_mean %>% ee_print()
ndvi_rescaled_monthly_historical_mean %>% ee_get_date_ic() %>% pull(time_start) %>% range()
ndvi_rescaled_monthly %>% ee_get_date_ic() %>% pull(time_start) %>% range()


ndvi_rescaled_monthly$first()$bandNames()$getInfo()
ndvi_rescaled_monthly_historical_mean$first()$bandNames()$getInfo()



recent_vs_historical_ndvi <- year_sequence$map(
  ee_utils_pyfunc(
     function(y) {
       month_sequence$map(
         ee_utils_pyfunc(
           function(m){
             recent_yrmo<- ee$Image(ndvi_rescaled_monthly$
              filter(ee$Filter$calendarRange(y, y, 'year'))$
              filter(ee$Filter$calendarRange(m, m, 'month'))$
                first()
             )
             
             hist_mo <- ee$Image(ndvi_rescaled_monthly_historical_mean$
                                   filter(ee$Filter$calendarRange(2000, 2000, 'year'))$
                                   filter(ee$Filter$calendarRange(m, m, 'month'))$
                                   first()
               )
             
            
            historical_min <- hist_mo$select("NDVI_min")
            historical_max <- hist_mo$select("NDVI_max")
            
            NDVI_diff <- recent_yrmo$select("NDVI")$
              subtract(hist_mo$select("NDVI_mean"))$
              rename("NDVI_diff")
            
            NDVI_z <- NDVI_diff$select("NDVI_diff")$
              divide(hist_mo$select("NDVI_std"))$
              rename("NDVI_Z")
            
            # max_diff_min <- - historical_max$
            #   subtract(historical_min)
            
            max_diff_min <-  hist_mo$select("NDVI_max")$
              subtract( hist_mo$select("NDVI_min"))$
              rename("max_diff_min")
          
            NDVI_VCI_diff <- recent_yrmo$select("NDVI")$
              subtract(hist_mo$select("NDVI_min"))$
              rename("VCI_NDVI_diff")
            # 
            NDVI_VCI <- NDVI_VCI_diff$
              select("VCI_NDVI_diff")$
              subtract(max_diff_min$select("max_diff_min"))$
              rename("VCI_NDVI")
            
            recent_yrmo$
              addBands(NDVI_diff)$
              addBands(NDVI_z)$
              addBands(NDVI_VCI)$
              set("system:time_start",ee$Date$millis(ee$Date$fromYMD(y,m,1)))
           }
         )
       )
       
     }
  
)
)



recent_vs_historical_ndvi_ic <- ee$ImageCollection$fromImages(recent_vs_historical_ndvi$flatten())
recent_vs_historical_ndvi_ic %>% ee_print()
recent_vs_historical_ndvi_ic$first()$bandNames()$getInfo()


recent_vs_historical_ndvi_ic_renamed <- recent_vs_historical_ndvi_ic |> 
  ee$ImageCollection$map(
    function(x) {
      date <- ee$Date(x$get("system:time_start"))$format('YYYY_MM_dd')
      # name <- ee$String$cat("pr_", date)
      # x$select("NDVI")$rename(name)
      
      ndvi_bandname <- ee$String$cat("NDVI_", date)
      diff_ndvi_bandname <- ee$String$cat("diff_NDVI_", date)
      z_ndvi_bandname <- ee$String$cat("z_NDVI_", date)
      x$rename(ndvi_bandname,diff_ndvi_bandname,z_ndvi_bandname)
    }
  )




system.time( #36 s
monthly_ndvi_params <- ee_extract(x = recent_vs_historical_ndvi_ic_renamed,
                           y=woi["ADM3_PCODE"],
                           scale=250, # dont fogrget to set scale properly
                           fun= ee$Reducer$mean(),sf=T)
)

monthly_ndvi_ward_long <- monthly_ndvi_params |> 
       st_drop_geometry() |> 
      pivot_longer(-1) |> 
      mutate(
        parameter= str_extract(string = name,pattern = "diff_NDVI|_NDVI_|z_NDVI") |> 
          str_replace_all(pattern = "_NDVI_","NDVI"),
        date= str_remove(string = name, pattern = ".*NDVI_") |> 
          str_replace_all("_","-") |> lubridate::ymd()
  )

admin_dissolved <- admins$state %>% 
  summarise() %>% 
  mutate(admin="overall")
monthly_ndvi_params_overall <- ee_extract(x = recent_vs_historical_ndvi_ic_renamed,
                           y=admin_dissolved["admin"],
                           scale=250, # dont fogrget to set scale properly
                           fun= ee$Reducer$mean(),sf=T)


monthly_ndvi_overall_long <- monthly_ndvi_params_overall |> 
       st_drop_geometry() |> 
      pivot_longer(-1) |> 
      mutate(
        parameter= str_extract(string = name,pattern = "diff_NDVI|_NDVI_|z_NDVI") |> 
          str_replace_all(pattern = "_NDVI_","NDVI"),
        date= str_remove(string = name, pattern = ".*NDVI_") |> 
          str_replace_all("_","-") |> lubridate::ymd()
  )



monthly_ndvi_overall_long %>% 
  filter(parameter!="NDVI") %>% 
  ggplot(aes(x=date, y= value))+
   scale_x_date(
    minor_breaks = "1 month",
    breaks= "1 year",
    # major="year",
    labels=scales::date_format("%b%y")
  )+
  # scale_x_date()+
  geom_line()+
  geom_vline(xintercept=lubridate::ymd("2016-03-01"),linetype='dashed')+
  geom_vline(xintercept=lubridate::ymd("2017-03-01"),linetype='dashed')+
  geom_hline(yintercept=0,color="red")+
  facet_wrap(~parameter,nrow=2, scales = "free_y")+
  theme_bw()
  


```


## Compile RS ward level

```{r}
env_params_ward<- list(monthly_precip_ward_long,
                       monthly_ndvi_ward_long,
                       monthly_soil_moisture_ward_long) %>% 
  map_dfr(~.x %>% 
            select(ADM3_PCODE, value, parameter, date))


env_params_ward %>% 
  count(parameter)

env_params_ward %>% 
  filter(date>="2016-01-01") %>% 
  count(parameter)

env_params_ward_gte2016 <- env_params_ward %>% 
    filter(date>="2016-01-01") 

env_params_ward_gte2016 %>% 
  count(parameter)

env_params_ward_gte2016_labelled <- env_params_ward_gte2016 %>% 
  left_join(woi %>% 
              st_drop_geometry() %>% 
              select(ADM3_PCODE,ADM3_EN, ADM2_EN,ADM2_PCODE,ADM1_EN)) %>% 
  select(date,matches("^ADM"), parameter,everything())
  
```


```{r}


env_params_ward_gte2016_labelled %>% 
  filter(str_detect(parameter,"NDVI")) %>% 
  filter(parameter %in% c("diff_NDVI","z_NDVI")) %>% 
  filter(ADM3_EN=="Alau") %>% 
  ggplot(aes(x= date, y= value))+
  geom_line()+
  scale_x_date(
    minor_breaks = "1 month",
    breaks= "1 year",
    # major="year",
    labels=scales::date_format("%b")
  )+
  geom_hline(yintercept=0, color="red")+
  facet_wrap(~parameter,nrow=3,scales = "free_y")+
  theme(
    axis.text.x = element_text(angle=90)
  )

# 
# env_params_ward_gte2016_labelled %>% 
#   write_csv("nga_env_params_by_ward_maidu_jere.csv")

```



```{r}
muac_monthly_ward <- muac %>% 
  group_by(State,LGA,Ward,yr,mo) %>% 
  summarise(
    new_otp_admissions = sum(new_otp_admissions,na.rm=T)
  )


# there are some records with LGA missing, but ward present- should recode
ward_lga_lookup<- admins$ward$ADM2_EN |> 
  set_names(admins$ward$ADM3_EN)



muac_cleaned <- muac_monthly_ward %>% 
  ungroup() %>% 
  mutate(
    # across(.cols= matches("^muac_|^new_"), ~replace_na(.x,0)),
    across(.cols = c("State","LGA","Ward"),~str_to_title(.x)),
    mo= str_to_title(mo),
    date= paste0(yr,"-",mo,"-01"),
    date_dt= lubridate::ymd(date),
    LGA= str_replace_all(LGA, c("Askira-Uba"="Askira/Uba",
                                "Postiskum" ="Potiskum" ,
                                "Gaidam" ="Geidam",
                                "Tarmuwa" ="Tarmua" )),
    # fix these na LGAs that have wards
    LGA = if_else(is.na(LGA),recode(Ward, !!!ward_lga_lookup),LGA)
    
    )
ward %>% 
  mutate(
    ward_name= str_to_title(ADM3_EN)
  ) %>% 
  filter(str_detect(ward_name,"Gaji"))
woi %>% 
  pull(ADM3_EN)
muac_cleaned %>% 
  # 7 records of Gajigana in Maiduguri, but admin boundaries say it should be in Magumeri...
  mutate(
    LGA2 = if_else(str_detect(Ward,"Gaji"),"Magumeri",LGA)
  ) %>% 
  filter(str_detect(Ward,"Gaji"))
  filter(State=="Borno") %>% 
  filter(LGA%in% c("Maiduguri","Jere")) %>% 
  
  count(Ward) %>% 
  mutate(
    ward2= str_to_title(str_squish(Ward)),
    ward3 = case_when(
      ward2 %in% c("Bolori Ii",
                   "Bolori Ii",
                   "Bolori-Ii",
                   "Bolori 2",
                   "Bolori 2a&2c",
                   "Bolori 2b&D")~"Bolori II",
      # apparently there is teachers village in both bolori 1 & 2 - did both
      str_detect(ward2,"^Bolori.*|^Teacher.*|^Pompo.*")~"Bolori I",
      str_detect(ward2,"^Bulab.+in$|^Bulab.+")~"Bulablin",
      str_detect(ward2,"^Dala.+")~"Dala",
      str_detect(ward2,"^Dus[um].+|^Muna_eth.*")~"Dusuma",
      str_detect(ward2,"^G[ao]mboru.+")~"Gamboru",
      str_detect(ward2,"^Gomari.*|Gangamari")~"Gomari",
      ward2 %in% c("Gwange","Gwange I","Gwange 1&2","Gwange-I","Gwnge 1")~"Gwange I",
      ward2 %in% c("Gwange Ii")~"Gwange II",
      ward2 %in% c("Gwange Iii","Gwange 3")~"Gwange III",
      ward2 %in% c("Shehuri","Shehuri North","Shehuru North")~"Shehuri North",
      str_detect(ward2,"^Shuwari.*|Shok")~"Shehuri North",
      str_detect(ward2,"^Maisandari.*")~ "Maisandari" ,
      str_detect(ward2,"^Lam[iu]sula*")~ "Lamisula" ,
      str_detect(ward2,"^Musari*|Maimusari.*")~ "Maimusari" ,
      str_detect(ward2,"^Mashamari*")~ "Mashamari" ,
      
      #,https://reliefweb.int/sites/reliefweb.int/files/resources/referral_pathway_mmc_jere_final_24.03.17.pdf
      str_detect(ward2,"^Gw[oa]zar*")~ "Dusuma" ,
      str_detect(ward2,"^Sabon.*|^Bale.*")~ "Galtimari",
      # Gajigana  - there is a ward called Gajigana in Magumeri... maybe it should b
      TRUE~ ward2
    )
  ) %>% 
  count(ward3) %>% 
  print(n=460)
  
```









